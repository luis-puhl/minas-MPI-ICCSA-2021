
\begin{algorithm}[htb]
% {\scriptsize
% \begin{multicols}{2}
    % \SetAlgoVlined
    \SetKwProg{Function}{Function}{:}{}
    \SetKwFor{With}{with}{}{}
    \SetKw{continue}{continue}
    % 
    \SetKwData{cleaningWindow}{cleaningWindow}
    \SetKwData{noveltyDetectionTrigger}{noveltyDetectionTrigger}
    \SetKwData{MEPC}{MEPC}
    \SetKwData{NF}{NF}
    \SetKwData{mpiSize}{mpiSize}
    \SetKwData{mpiRank}{mpiRank}
    \SetKwData{EndOfStream}{EndOfStream}
    % 
    \KwSty{Parameters}: \cleaningWindow, \noveltyDetectionTrigger,
    mpiClusterSize as \mpiSize,
    mpiNodeRank as \mpiRank
    \\
    % 
    \SetKwFunction{Mfog}{Mfog}
    \SetKwFunction{Sampler}{Sampler}
    \SetKwFunction{Classifier}{Classifier}
    \SetKwFunction{Detector}{Detector}
    \SetKwFunction{modelReceiver}{modelReceiver}
    % 
    \SetKwFunction{sizeOf}{sizeOf}
    \SetKwFunction{typeOf}{typeOf}
    % 
    \SetKwFunction{Thread}{Thread}
    \SetKwFunction{Lock}{Lock}
    \SetKwFunction{readLock}{readLock}
    \SetKwFunction{writeLock}{writeLock}
    % 
    \SetKwFunction{receive}{receive}
    \SetKwFunction{send}{send}
    \SetKwFunction{broadcast}{broadcast}
    % 
    \SetKwFunction{nearestCluster}{nearestCluster}
    \SetKwFunction{NoveltyDetection}{NoveltyDetection}
    \SetKwFunction{handleModelSleep}{handleModelSleep}
    \SetKwFunction{removeOldSamples}{removeOldSamples}
    \SetKwFunction{now}{now}
    % 
    \KwIn{ModelSet, Sample Stream}
    \KwOut{Classified Stream as $out$}
    % 
    \Function{\Mfog{ModelStream, InputStream}}{
        ModelSet = $\emptyset$\;
        ModelSetLock = \textbf{new} \Lock()\;
        \eIf(\emph{root}){\mpiRank == 0}{
            \textbf{new} \Thread(\Detector, [ModelSet])\;
            \Sampler(InputStream)\;
        }(\emph{leaf}){
            \textbf{new} \Thread(\modelReceiver, [ModelSet])\;
            \Classifier(ModelSet)\;
        }
    }
\caption{MFOG: main MPI entry-point.}
\label{alg:MFOG}
\end{algorithm}

\begin{algorithm}[htb]
    \SetKwFor{With}{with}{}{}
    \SetKw{continue}{continue}
    % 
    % \SetKwData{CW}{CW}
    % \SetKwData{noveltyDetectionTrigger}{NDT}
    \SetKwData{MEPC}{MEPC}
    \SetKwData{NF}{NF}
    \SetKwData{mpiSize}{mpiSize}
    \SetKwData{mpiRank}{mpiRank}
    \SetKwData{EndOfStream}{EndOfStream}
    % 
    \SetKwProg{Function}{Function}{:}{}
    \Function{\Classifier{mp}}{
        \While{ True }{
            sampe = \receive(SampleType, root)\;
            \lIf{sample == \EndOfStream}{\textbf{break}}
            sample.label = unknown\;
            \With{\readLock(ModelSetLock)}{
                (distance, cluster) = \nearestCluster(sample, ModelSet)\;
            }
            \If{distance $<$ cluster.radius}{
                sample.label = cluster.label\;
            }
            \send(root, SampleType, sample)\;
        }
    }
%     \label{alg:MFOG-classifier}
%     \caption{MFOG: Classifier task.}
% \end{algorithm}
% \begin{algorithm}
    % \SetKwProg{algorithm}{algorithm}{:}{}
    \SetKwFor{With}{with}{}{}
    \SetKw{continue}{continue}
    % 
    \SetKwData{CW}{CW}
    \SetKwData{noveltyDetectionTrigger}{NDT}
    \SetKwData{MEPC}{MEPC}
    \SetKwData{NF}{NF}
    \SetKwData{mpiSize}{mpiSize}
    \SetKwData{mpiRank}{mpiRank}
    \SetKwData{EndOfStream}{EndOfStream}
    % 
    \SetKwProg{Function}{Function}{:}{}
    \Function{\modelReceiver{mp, ModelSet}}{
        \While{ True }{
            cl = \receive(ClusterType, root)\;
            \lIf{cl == \EndOfStream}{\textbf{break}}
            \With{writeLock(ModelSetLock)}{
                ModelSet = ModelSet $\cup$ cl\;
            }
        }
    }
    % \label{alg:MFOG-model}
    % \caption{MFOG: model receiver task.}
\caption{MFOG Leaf Tasks: Model Receiver and Classifier.}
\label{alg:MFOG-leaf}
\end{algorithm}
\begin{algorithm}[htb]
    \SetKwFor{With}{with}{}{}
    \SetKw{continue}{continue}
    % 
    \SetKwData{CW}{CW}
    \SetKwData{noveltyDetectionTrigger}{NDT}
    \SetKwData{MEPC}{MEPC}
    \SetKwData{NF}{NF}
    \SetKwData{mpiSize}{mpiSize}
    \SetKwData{mpiRank}{mpiRank}
    \SetKwData{EndOfStream}{EndOfStream}

    \SetKwProg{Function}{Function}{:}{}
    \Function{\Sampler{mp, p, InputStream}}{
        % ModelSet = read()\;
        % broadcast(ModelSet)\;
        dest = 1\;
        \ForEach{ sample from InputStream }{
            \If{\typeOf(sample) is Cluster}{
                \broadcast(ClusterType, sample, root)\;
                \With{\writeLock(ModelSetLock)}{
                    ModelSet = ModelSet $\cup$ sample\;
                }
                \continue\;
            }
            % sample.label = unknown\;
            \send(dest, SampleType, sample)\;
            dest = dest $+ 1$\;
            \lIf{dest $>$ \mpiSize}{dest = 1}
        }
    }

%     \label{alg:MFOG-sampler}
%     \caption{MFOG: sampler Module.}
% \end{algorithm}
% \begin{algorithm}
    \SetKwProg{algorithm}{algorithm}{:}{}
    \SetKwFor{With}{with}{}{}
    \SetKw{continue}{continue}
    % 
    \SetKwData{CW}{CW}
    \SetKwData{noveltyDetectionTrigger}{NDT}
    \SetKwData{MEPC}{MEPC}
    \SetKwData{NF}{NF}
    \SetKwData{mpiSize}{mpiSize}
    \SetKwData{mpiRank}{mpiRank}
    \SetKwData{EndOfStream}{EndOfStream}

    \SetKwProg{Function}{Function}{:}{}
    \Function{\Detector{mp, ModelSet}}{
        lastCleanup = 
        \While{ True }{
            sampe = \receive(SampleType, any)\;
            \lIf{sample == \EndOfStream}{\textbf{break}}
            $out \leftarrow$ sample\;
            \If{sample.label == unknown}{
                UnkownSet = UnkownSet $\cup$ sample\;
                \If{\sizeOf(UnkownSet) $\geq$ \noveltyDetectionTrigger}{
                    novelties = \NoveltyDetection(p, ModelSet, *UnkownSet)\;
                    \With{\writeLock(ModelSetLock)}{
                        ModelSet = ModelSet $\cup$ novelties\;
                    }
                    \ForEach{ cl in novelties }{
                        \broadcast(ClusterType, cl, root)\;
                    }
                }
                \If{\now() $>$ lastCleanup $+$ \CW}{
                    ModelSet = \handleModelSleep(ModelSet, ModelSleepSet)\;
                    UnkownSet = \removeOldSamples(UnkownSet, lastCleanup)\;
                }
            }
        }
    }
    % \label{alg:MFOG-detector}
    % \caption{MFOG: detector task.}
\caption{MFOG Root Tasks: Sampler and Detector.}
\label{alg:MFOG-root}
\end{algorithm}
% % \end{multicols}
% % }
% \label{alg:MFOG}
% \caption{MFOG: MINAS implemented over MPI.}
% \end{algorithm}

% \begin{algorithm}[h]
% {\scriptsize
%     \SetAlgoVlined
%     \SetKwProg{Fn}{algorithm}{:}{}
%     \SetKwFor{With}{with}{}{}
    
%     \SetKwFunction{Fb}{Detector}
%     \Fn{\Fb{mp, p, ModelSet}}{
%         \While{ True }{
%             sampe = receive(SampleType, any)\;
%             \lIf{sample == EndOfStream}{\textbf{break}}
%             $out \leftarrow$ sample\;
%             \If{sample.label == unknown}{
%                 UnkownSet = UnkownSet $\cup$ sample\;
%                 \If{sizeOf(UnkownSet) $\geq$ p.noveltyDetectionTrigger}{
%                     novelties = NoveltyDetection(p, *ModelSet, $\emptyset$, *UnkownSet)\;
%                     \With{writeLock(ModelSetLock)}{
%                         ModelSet = ModelSet $\cup$ novelties\;
%                     }
%                     \ForEach{ cl in novelties }{
%                         broadcast(ClusterType, cl, root)\;
%                     }
%                 }
%             }
%         }
%     }
    
%     \SetKwFunction{Fc}{modelReceiver}
%     \Fn{\Fc{mp, p, ModelSet}}{
%         \While{ True }{
%             cl = receive(ClusterType, root)\;
%             \lIf{cl == EndOfStream}{\textbf{break}}
%             \With{writeLock(ModelSetLock)}{
%                 ModelSet = ModelSet $\cup$ cl\;
%             }
%         }
%     }
% }
% \label{alg:MFOG_2}
% \caption{mfog pt. 2.}
% \end{algorithm}